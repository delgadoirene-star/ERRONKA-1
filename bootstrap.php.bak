<?php
/**
 * Bootstrap file for common includes and setup.
 */

// Session settings before start
ini_set('session.cookie_secure', !empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' ? '1' : '0');
ini_set('session.cookie_httponly', '1');
ini_set('session.use_only_cookies', '1');
ini_set('session.cookie_samesite', 'Lax');
ini_set('session.use_strict_mode', '1');

require_once __DIR__ . '/vendor/autoload.php';

// Start session via Seguritatea
require_once __DIR__ . '/model/seguritatea.php';
Seguritatea::hasieratuSesioa();

// Load DB and config
require_once __DIR__ . '/config/konexioa.php';
require_once __DIR__ . '/config/config.php';

// Initialize Hashids globally if available
global $hashids;
$hashids = class_exists('\\Hashids\\Hashids') ? new \Hashids\Hashids('ZAB_IGAI_PLAT_GEN', 8) : null;

/**
 * Helper to build router-safe page links.
 * Usage: page_link(6, 'profile') -> "/<encoded>.php" when Hashids enabled or "/profile.php" otherwise
 */
if (!function_exists('page_link')) {
    function page_link(int $pageId, string $fallback = ''): string {
        global $hashids;
        if ($hashids !== null) {
            return '/' . $hashids->encode($pageId) . '.php';
        }
        $name = $fallback ?: 'page' . $pageId;
        return '/' . ltrim($name, '/') . '.php';
    }
}

// New helpers to reduce duplication across the codebase
if (!function_exists('encode_id')) {
    function encode_id(int $id): string|int {
        global $hashids;
        return ($hashids !== null) ? $hashids->encode($id) : $id;
    }
}

if (!function_exists('encode_page')) {
    function encode_page(int $pageId, string $fallback = ''): string {
        return page_link($pageId, $fallback);
    }
}

if (!function_exists('redirect_to')) {
    function redirect_to(string $path): void {
        if (!headers_sent()) {
            header('Location: ' . $path);
        } else {
            echo "<script>location.href=" . json_encode($path) . ";</script>";
        }
        exit;
    }
}

if (!function_exists('current_user')) {
    function current_user(mysqli $conn): ?array {
        $uid = $_SESSION['usuario_id'] ?? null;
        return $uid ? Usuario::lortuIdAgatik($conn, $uid) : null;
    }
}